(window.webpackJsonp=window.webpackJsonp||[]).push([[13],{147:function(s,t,n){"use strict";n.r(t);var a=n(0),e=Object(a.a)({},(function(){var s=this.$createElement;this._self._c;return this._m(0)}),[function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("div",{staticClass:"content"},[n("h2",{attrs:{id:"_1-生产环境所需要素"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-生产环境所需要素","aria-hidden":"true"}},[s._v("#")]),s._v(" 1. 生产环境所需要素")]),n("div",{staticClass:"tip custom-block"},[n("p",{staticClass:"custom-block-title"},[s._v("TIP")]),n("ol",[n("li",[s._v("购买自己的域名")]),n("li",[s._v("购买自己的服务器")]),n("li",[s._v("域名备案")]),n("li",[s._v("配置服务器应用环境")]),n("li",[s._v("安装配置数据库")]),n("li",[s._v("项目远程部署发布与更新")])])]),n("h2",{attrs:{id:"_2-远程登录服务器"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-远程登录服务器","aria-hidden":"true"}},[s._v("#")]),s._v(" 2. 远程登录服务器")]),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("// 登录,服务器为Ubuntu "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("16.04")]),s._v(".4 LTS版本\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" root@公网ip\n\n// 显示硬盘信息\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("fdisk")]),s._v(" -l\n\n// 查看硬盘使用情况\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("df")]),s._v(" -h\n\n// 显示所有目录\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" -a\n")])])]),n("h2",{attrs:{id:"_3-配置root及权限帐号"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-配置root及权限帐号","aria-hidden":"true"}},[s._v("#")]),s._v(" 3. 配置root及权限帐号")]),n("h3",{attrs:{id:"_3-1-添加用户"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-添加用户","aria-hidden":"true"}},[s._v("#")]),s._v(" 3-1. 添加用户")]),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("// 添加用户,输入密码\nadduser  用户名\n\n// 以sudo来调用授权\ngpasswd -a 用户名 "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v("\n\n// \n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" visudo\n\n// 在sudoers.tmp文件中user privilege specification中添加一行\n用户名 "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ALL")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ALL:ALL"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" ALL\nctrl + x保存， 然后shift + y 回车退出\n")])])]),n("h3",{attrs:{id:"_3-2-配置本地无密码-ssh-登录"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-配置本地无密码-ssh-登录","aria-hidden":"true"}},[s._v("#")]),s._v(" 3-2. 配置本地无密码 SSH 登录")]),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("// 查看根目录\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("pwd")]),s._v("\n\n// 查看有没有.ssh文件夹\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" -a\n\n// 创建.ssh， 进入目录\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" .ssh\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" .ssh\n\n// 生成私/公钥，服务器和本地登录的电脑都需要生成，把本地电脑生成的公钥上传至服务器的authorized_keys文件中，然后通过算法比对来实现无密码登录\nssh-keygen -t rsa -b "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4096")]),s._v(" -C "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"邮箱"')]),s._v("\n然后一路回车不输入密码\n在.ssh 中 "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" 可以看到生成了id_rsa id_rsa.pub\n\n// 查看id_rsa \n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" id_rsa\n\n// 开启ssh代理\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("eval")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),n("span",{pre:!0,attrs:{class:"token variable"}},[n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),s._v("ssh-agent -s"),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v('"')]),s._v("\n返回 Agent pid xxxxx  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("20702")]),s._v("\n\n// 把key加入到代理中\nssh-add ~/.ssh/id_rsa\n\n// 创建授权文件\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("vi")]),s._v(" authorized_keys\n输入shift + "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v("  ，然后wq"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("保存\n\n// 把本地的公钥输入进去\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("vi")]),s._v(" authorized_keys\ni 输入本地公钥, esc, 输入shift + "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v("  ，然后wq"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("保存\n\n// 修改authorized_keys权限\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("chmod")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("600")]),s._v(" authorized_keys\n\n// 重启ssh服务\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" restart\n")])])]),n("h2",{attrs:{id:"_4-增强服务器"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-增强服务器","aria-hidden":"true"}},[s._v("#")]),s._v(" 4. 增强服务器")]),n("h3",{attrs:{id:"_4-1-修改服务器默认登录端口"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-修改服务器默认登录端口","aria-hidden":"true"}},[s._v("#")]),s._v(" 4-1. 修改服务器默认登录端口")]),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("// 修改默认的22端口, 最好是开两个，怕修改错误后导致登录不进去了\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("vi")]),s._v(" /etc/ssh/sshd_config\n\n// 找到port，按下i激活修改模式，修改端口, 不要修改到0-1024端口, 然后在最下面找到UseDNS为no,在最下面新增username,esc 退出修改模式, "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("shift")]),s._v(" + :, wq"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("保存退出\nport xxxxx \nAllowUsers username\n\n// 重启ssh服务\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" restart\n\n// 重新登录\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" -p 端口号 username@ip地址\n")])])]),n("div",{staticClass:"tip custom-block"},[n("p",{staticClass:"custom-block-title"},[s._v("TIP")]),n("p",[s._v("如果还登录不上去的话，直接去阿里云服务器的控制台添加一份安全组规则入方向，端口号为自己设定的端口号即可。")])]),n("h3",{attrs:{id:"_4-2-禁用root登录"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-禁用root登录","aria-hidden":"true"}},[s._v("#")]),s._v(" 4-2. 禁用root登录")]),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("// 继续修改这个文件\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("vi")]),s._v(" /etc/ssh/sshd_config\n\n// 设置PermitRootLogin 和PasswordAuthentication， 保存后退出\nPermitRootLogin no\n和PasswordAuthentication no\n\n// 重启ssh服务\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" restart\n")])])]),n("div",{staticClass:"tip custom-block"},[n("p",{staticClass:"custom-block-title"},[s._v("TIP")]),n("p",[s._v("记得查看有没有这个，禁止空密码登录，一定要设置为no\nPermitEmptyPasswords no")])]),n("h3",{attrs:{id:"_4-3-配置-iptables-和-fail2ban-增强安全防护"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-配置-iptables-和-fail2ban-增强安全防护","aria-hidden":"true"}},[s._v("#")]),s._v(" 4-3. 配置 iptables 和 Fail2Ban 增强安全防护")]),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("// 清空所有iptables规则\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" iptables -F\n\n// 添加规则, 具体配置如下\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("vi")]),s._v(" /etc/iptables.up.rules\n\n* filter\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# allow all connections")]),s._v("\n-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# allow out traffic")]),s._v("\n-A OUTPUT -j ACCEPT\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# allow http https ")]),s._v("\n-A INPUT -p TCP --dport "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("443")]),s._v(" -j ACCEPT\n-A INPUT -p TCP --dport "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v(" -j ACCEPT\n-A INPUT -p TCP --dport "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8088")]),s._v(" -j ACCEPT\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# allow ssh port login")]),s._v("\n-A INPUT -p tcp -m state --state NEW --dport "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("39999")]),s._v(" -j ACCEPT\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ping")]),s._v("\n-A INPUT -p icmp -m icmp --icmp-type "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v(" -j ACCEPT\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# log denied calls")]),s._v("\n-A INPUT -m limit --limit "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("/min -j LOG --log-prefix "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"iptables denied:"')]),s._v(" --log-level "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# drop incomming sensitive connections")]),s._v("\n-A INPUT -p tcp --dport "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v(" -i eth0 -m state --state NEW -m recent --set\n-A INPUT -p tcp --dport "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v(" -i eth0 -m state --state NEW -m recent --update --seconds "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("60")]),s._v(" --hitcount "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("150")]),s._v(" -j DROP\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# reject all other inbound ")]),s._v("\n-A INPUT -j REJECT\n-A FORWARD -j REJECT\n\nCOMMIT\n\n// 配置路径，修改了iptables后需要执行这个命令来重启规则\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" iptables-restore "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" /etc/iptables.up.rules\n\n// 激活防火墙,查看防火墙状态\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" ufw status\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" ufw "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("enable")]),s._v("\n\n// 设置关机后自动启动的脚本，内容如下\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("vi")]),s._v(" /etc/network/if-up.d/iptables\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#!/bin/sh")]),s._v("\niptables-restore /etc/iptables.up.rules\n\n// 给与脚本权限\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("chmod")]),s._v(" +x /etc/network/if-up.d/iptables\n")])])]),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("// 安装Fail2Ban\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt-get")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" fail2ban\n\n// 查看配置文件\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("vi")]),s._v(" /etc/fail2ban/jail.conf\n\n// 修改bantime,action\nbantime "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3600")]),s._v("\naction "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" %"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("action_mw"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("s\n\n// 查看有没有运行\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" fail2ban status\n")])])]),n("h2",{attrs:{id:"_5-搭建-nodejs-生产环境"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-搭建-nodejs-生产环境","aria-hidden":"true"}},[s._v("#")]),s._v(" 5. 搭建 Nodejs 生产环境")]),n("h3",{attrs:{id:"_5-1-搭建服务器nodejs环境"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-搭建服务器nodejs环境","aria-hidden":"true"}},[s._v("#")]),s._v(" 5-1. 搭建服务器Nodejs环境")]),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("// 更新一下系统\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt-get")]),s._v(" update\n\n// 安装需要的包\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt-get")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" openssl build-essential libssl-dev "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v("\n\n// 拷贝https://github.com/creationix/nvm的脚本并且执行，安装nvm\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" -qO- https://raw.githubusercontent.com/creationix/nvm/v0.33.11/install.sh "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("bash")]),s._v("\n\n// 新开一个窗口安装nodejs\nnvm "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" v10.13.0\n\n// 默认使用版本\nnvm use v10.13.0\nnvm "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("alias")]),s._v(" default v10.13.0\n\n// 查看node版本，安装淘宝镜像\nnode -v \n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("npm")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -g cnpm --registry"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("https://registry.npm.taobao.org\n\n// 增加系统文件监控数目\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" fs.inotify.max_user_watches"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("524288")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("tee")]),s._v(" -a /etc/sysctl.conf "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" sysctl -p\n\n// 安装一些需要的模块\ncnpm i pm2 webpack gulp grunt-cli -g\n\n// 在根目录写一个app.js启动服务\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("vi")]),s._v(" app.js\nconst http "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" require"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'http'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nhttp.createServer"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("((")]),s._v("req,res"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    res.writeHead"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v(", "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Content-type'")]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'text/plain'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    res.end"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'hello world'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(".listen"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8081")]),s._v(", "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    console.log"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Server running!'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nnode app.js\n\n// 访问ip地址加端口号即可,如果没有反应需要在服务器配置安全组8081的端口号进出口规则\n")])])]),n("h3",{attrs:{id:"_5-2-部署pm2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-部署pm2","aria-hidden":"true"}},[s._v("#")]),s._v(" 5-2. 部署pm2")]),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("// 可以直接通过pm2开启服务\npm2 start app.js\n\n// 查看列表\npm2 list\n\n// 查看详情\npm2 show app\n\n// 查看日志\npm2 logs\n")])])]),n("h2",{attrs:{id:"_6-配置-nginx-反向代理-nodejs-端口"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-配置-nginx-反向代理-nodejs-端口","aria-hidden":"true"}},[s._v("#")]),s._v(" 6. 配置 Nginx 反向代理 Nodejs 端口")]),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("// 安装nginx，版本\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt-get")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" nginx\nnginx -v\n\n// 查看文件\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /etc/nginx/\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" conf.d\n\n// 新建配置文件\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("vi")]),s._v(" xxx-com-8080.conf"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("文件名"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\nupstream xxx "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    server "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:8081"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\nserver "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  listen: "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  server_name: ip地址或者域名地址"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  location / "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    proxy_set_header X-Real-IP "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$remote_addr")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    proxy_set_header X-Forward-For "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$proxy_add_x_forwarded_for")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    proxy_set_header Host "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$http_host")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    proxy_set_header X-Nginx-Proxy "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    proxy_pass http://xxx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    proxy_redirect off"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n  location ~* ^.+"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("."),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("jpg"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("jgeg"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("gif"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("png"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("ico"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("css"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("js"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("pdf"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("txt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    root /www/wx-jssdk/production/current/public"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n// 查看nginx.conf文件\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("vi")]),s._v(" nginx.conf\n查看这句是否正确include /etc/nginx/conf.d/*.conf"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n取消注释 server_tokens off,这句是后台返回的server里面不显示版本信息，只显示一个nginx\n\n\n// 测试配置文件是否正确\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" nginx -t\n\n// 重启nginx\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" nginx -s reload\n\n// 访问ip地址即可,如果没有反应需要在服务器配置安全组80的端口号进出口规则\n// 解析域名，填入自己的ip地址即可，可以访问域名+端口号\n")])])]),n("h2",{attrs:{id:"_7-服务器配置安装-mongodb"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_7-服务器配置安装-mongodb","aria-hidden":"true"}},[s._v("#")]),s._v(" 7. 服务器配置安装 MongoDB")]),n("h3",{attrs:{id:"_7-1-安装-mongodb"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_7-1-安装-mongodb","aria-hidden":"true"}},[s._v("#")]),s._v(" 7-1. 安装 MongoDB")]),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("// 根据步骤安装 \nhttps://docs.mongodb.com/manual/tutorial/install-mongodb-on-ubuntu/\n\n// 开启mongodb\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" mongod start\n\n// 查看日志有没有开启,或者直接mongo\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /var/log/mongodb/mongod.log\nmongo\n\n// 在iptables中开启27017这个端口，不然mongo链接失败\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mongodb connection")]),s._v("\n-A INPUT -s "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 -p tcp --destination-port "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("27017")]),s._v(" -m state --state NEW,ESTABLISHED -j ACCEPT\n-A OUTPUT -d "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 -p tcp --source-port "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("27017")]),s._v(" -m state --state ESTABLISHED -j ACCEPT\n\n// 重启规则\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" iptables-restore "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" /etc/iptables.up.rules\n\n// 停止和重启mongodb\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" mongod stop "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("||")]),s._v(" restart\n\n// 修改默认27017端口，找到net下面port修改，然后记得更新iptables，重载iptabales\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("vi")]),s._v(" /etc/mongod.conf\n\n// 登录mongo\nmongo --port xxxxx\n")])])]),n("h2",{attrs:{id:"_8-服务器正式部署和发布上线项目"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_8-服务器正式部署和发布上线项目","aria-hidden":"true"}},[s._v("#")]),s._v(" 8. 服务器正式部署和发布上线项目")]),n("h3",{attrs:{id:"_8-1-上传项目代码到线上私有-git-仓库"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_8-1-上传项目代码到线上私有-git-仓库","aria-hidden":"true"}},[s._v("#")]),s._v(" 8-1. 上传项目代码到线上私有 Git 仓库")]),n("ul",[n("li",[s._v("把本地和服务器的公钥都放在码云上面，然后在码云生成一个私有项目，并且在服务器git clone下来")])]),n("h3",{attrs:{id:"_8-2-配置-pm2-一键部署线上项目结构"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_8-2-配置-pm2-一键部署线上项目结构","aria-hidden":"true"}},[s._v("#")]),s._v(" 8-2. 配置 PM2 一键部署线上项目结构")]),n("p",[s._v("通过pm2这个工具，在我们本地的命令行上登录服务器，通知服务器从git仓库把代码clone到服务器里面，然后部署到相应的文件夹中")]),n("ul",[n("li",[s._v("配置PM2 ecosystem.json")])]),n("div",{staticClass:"language-json extra-class"},[n("pre",{pre:!0,attrs:{class:"language-json"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"apps"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"name"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"xxx"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"script"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"app.js"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 启动js")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"env"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"COMON_VARIABLE"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"true"')]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"env_production"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"NODE_ENV"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"production"')]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"deploy"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"production"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"user"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"配置好权限了的的用户帐号"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" \n      "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"host"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"服务器ip地址"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"ref"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"origin/master"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" \n      "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"repo"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"git仓库地址"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"port"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"端口号"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"path"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"~/www/wx-jssdk/production"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 服务器路径")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"post-deploy"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cnpm i && pm2 startOrRestart ecosystem.json --env production"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 部署的时候执行npm install")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"ssh_options"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"StrictHostKeyChecking=no"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"env"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token property"}},[s._v('"NODE_ENV"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"production"')]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("// 初始化服务器应用\npm2 deploy ecosystem.json production setup\n\n// 如果遇到mkdir: cannot create directory ‘/project’: Permission denied错误,就是权限问题\n// 在服务器根目录创建www和wx-jssdk，在www文件夹下面 "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("chmod")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("777")]),s._v(" wx-jssdk，修改文件夹权限， 如果成功ls会显示绿色\n\n// 开始部署， 如果出现bash: pm2: "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("command")]),s._v(" not found报错的话,执行下面的操作\npm2 deploy ecosystem.json production\n\n// 修改pm2\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("vi")]),s._v(" .bashrc\n\n// 注释这几行,: + wq"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("保存， 执行source .bashrc重载， 重新执行命令， 如果出现File ecosystem.json not found报错的话, 把代码git push更新到服务器即可\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#case $- in")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#    *i*) ;;")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#      *) return;;")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#esac")]),s._v("\n\n")])])]),n("h2",{attrs:{id:"_9-配置https证书"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_9-配置https证书","aria-hidden":"true"}},[s._v("#")]),s._v(" 9. 配置https证书")]),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("// 把解压后的证书上传服务器,:/home/xxx代表复制到服务器的那个路径中\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("scp")]),s._v(" -P "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("19999")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("服务器端口号"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" ./xxx.crt root@服务器ip地址:/home/xxx\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("scp")]),s._v(" -P "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("19999")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("服务器端口号"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" ./xxx.key root@服务器ip地址:/home/xxx\n\n// 修改nginx配置\nupstream tag "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  server "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:8081"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\nserver "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  listen "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  server_name www.xxx.com"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#rewrite ^(.*) https://$host$1 permanent;")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("return")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("301")]),s._v(" https://www.xxx.com"),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$request_uri")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\nserver "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  listen "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("443")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  server_name www.xxx.com"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  ssl on"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  ssl_certificate /etc/nginx/conf.d/ssl/cert-1541496084645_www.khweb.top.crt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  ssl_certificate_key /etc/nginx/conf.d/ssl/cert-1541496084645_www.khweb.top.key"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  ssl_session_timeout 5m"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  ssl_protocols SSLv2 SSLv3 TLSv1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  ssl_ciphers ALL:"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("ADH:"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  ssl_prefer_server_ciphers on"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$ssl_protocol")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    rewrite ^"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(".*"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" https://"),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$host")]),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$1")]),s._v(" permanent"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n  location / "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    proxy_set_header X-Real-IP "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$remote_addr")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    proxy_set_header X-Forward-For "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$proxy_add_x_forwarded_for")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    proxy_set_header Host "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$http_host")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    proxy_set_header X-Nginx-Proxy "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    proxy_pass http://tag"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    proxy_redirect off"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n\n// 重启nginx\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" nginx -s reload\n\n// 服务器安全组配置443端口即可\n")])])]),n("div",{staticClass:"tip custom-block"},[n("p",{staticClass:"custom-block-title"},[s._v("TIP")]),n("p",[s._v("存放证书的路径不要放在根目录,不然sudo nginx -t会报错")])])])}],!1,null,null,null);t.default=e.exports}}]);