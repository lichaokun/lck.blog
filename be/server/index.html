<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>1. 生产环境所需要素 | Lck.blog</title>
    <meta name="description" content="record what I want">
    <link rel="icon" href="/images/lck.png">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#3eaf7c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon-152x152.png">
  <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#3eaf7c">
  <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
  <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/assets/css/styles.8f0dc81e.css" as="style"><link rel="preload" href="/assets/js/app.8f0dc81e.js" as="script"><link rel="preload" href="/assets/js/13.bb8216ef.js" as="script"><link rel="prefetch" href="/assets/js/1.c2032add.js"><link rel="prefetch" href="/assets/js/10.c67e7d34.js"><link rel="prefetch" href="/assets/js/11.f4f3643c.js"><link rel="prefetch" href="/assets/js/12.93a9df87.js"><link rel="prefetch" href="/assets/js/14.68c1cda7.js"><link rel="prefetch" href="/assets/js/15.52390de1.js"><link rel="prefetch" href="/assets/js/16.6de63cc6.js"><link rel="prefetch" href="/assets/js/17.d913003c.js"><link rel="prefetch" href="/assets/js/18.19a93dd9.js"><link rel="prefetch" href="/assets/js/19.9e0f1f0a.js"><link rel="prefetch" href="/assets/js/2.c1916405.js"><link rel="prefetch" href="/assets/js/20.7242f631.js"><link rel="prefetch" href="/assets/js/21.f0d63d32.js"><link rel="prefetch" href="/assets/js/22.d387b9c8.js"><link rel="prefetch" href="/assets/js/23.f29027ac.js"><link rel="prefetch" href="/assets/js/24.9b7f547e.js"><link rel="prefetch" href="/assets/js/25.8bb6df85.js"><link rel="prefetch" href="/assets/js/26.a7830668.js"><link rel="prefetch" href="/assets/js/27.3f81e56b.js"><link rel="prefetch" href="/assets/js/28.67d57161.js"><link rel="prefetch" href="/assets/js/3.9f82c7f3.js"><link rel="prefetch" href="/assets/js/4.1d40e807.js"><link rel="prefetch" href="/assets/js/5.75d2cdbd.js"><link rel="prefetch" href="/assets/js/6.0a75455d.js"><link rel="prefetch" href="/assets/js/7.45416173.js"><link rel="prefetch" href="/assets/js/8.08900123.js"><link rel="prefetch" href="/assets/js/9.1a2b06f4.js">
    <link rel="stylesheet" href="/assets/css/styles.8f0dc81e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/" class="home-link router-link-active"><!----><span class="site-name">
      Lck.blog
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/article/" class="nav-link">article</a></div><!----></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/article/" class="nav-link">article</a></div><!----></nav><!----></div><div class="page"><div class="content"><h2 id="_1-生产环境所需要素"><a href="#_1-生产环境所需要素" aria-hidden="true" class="header-anchor">#</a> 1. 生产环境所需要素</h2><div class="tip custom-block"><p class="custom-block-title">TIP</p><ol><li>购买自己的域名</li><li>购买自己的服务器</li><li>域名备案</li><li>配置服务器应用环境</li><li>安装配置数据库</li><li>项目远程部署发布与更新</li></ol></div><h2 id="_2-远程登录服务器"><a href="#_2-远程登录服务器" aria-hidden="true" class="header-anchor">#</a> 2. 远程登录服务器</h2><div class="language-bash extra-class"><pre class="language-bash"><code>// 登录,服务器为Ubuntu <span class="token number">16.04</span>.4 LTS版本
<span class="token function">ssh</span> root@公网ip

// 显示硬盘信息
<span class="token function">fdisk</span> -l

// 查看硬盘使用情况
<span class="token function">df</span> -h

// 显示所有目录
<span class="token function">ls</span> -a
</code></pre></div><h2 id="_3-配置root及权限帐号"><a href="#_3-配置root及权限帐号" aria-hidden="true" class="header-anchor">#</a> 3. 配置root及权限帐号</h2><h3 id="_3-1-添加用户"><a href="#_3-1-添加用户" aria-hidden="true" class="header-anchor">#</a> 3-1. 添加用户</h3><div class="language-bash extra-class"><pre class="language-bash"><code>// 添加用户,输入密码
adduser  用户名

// 以sudo来调用授权
gpasswd -a 用户名 <span class="token function">sudo</span>

// 
<span class="token function">sudo</span> visudo

// 在sudoers.tmp文件中user privilege specification中添加一行
用户名 <span class="token assign-left variable">ALL</span><span class="token operator">=</span><span class="token punctuation">(</span>ALL:ALL<span class="token punctuation">)</span> ALL
ctrl + x保存， 然后shift + y 回车退出
</code></pre></div><h3 id="_3-2-配置本地无密码-ssh-登录"><a href="#_3-2-配置本地无密码-ssh-登录" aria-hidden="true" class="header-anchor">#</a> 3-2. 配置本地无密码 SSH 登录</h3><div class="language-bash extra-class"><pre class="language-bash"><code>// 查看根目录
<span class="token builtin class-name">pwd</span>

// 查看有没有.ssh文件夹
<span class="token function">ls</span> -a

// 创建.ssh， 进入目录
<span class="token function">mkdir</span> .ssh
<span class="token builtin class-name">cd</span> .ssh

// 生成私/公钥，服务器和本地登录的电脑都需要生成，把本地电脑生成的公钥上传至服务器的authorized_keys文件中，然后通过算法比对来实现无密码登录
ssh-keygen -t rsa -b <span class="token number">4096</span> -C <span class="token string">&quot;邮箱&quot;</span>
然后一路回车不输入密码
在.ssh 中 <span class="token function">ls</span> 可以看到生成了id_rsa id_rsa.pub

// 查看id_rsa 
<span class="token function">cat</span> id_rsa

// 开启ssh代理
<span class="token builtin class-name">eval</span> <span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span>ssh-agent -s<span class="token variable">)</span></span>&quot;</span>
返回 Agent pid xxxxx  <span class="token number">20702</span>

// 把key加入到代理中
ssh-add ~/.ssh/id_rsa

// 创建授权文件
<span class="token function">vi</span> authorized_keys
输入shift + <span class="token builtin class-name">:</span>  ，然后wq<span class="token operator">!</span>保存

// 把本地的公钥输入进去
<span class="token function">vi</span> authorized_keys
i 输入本地公钥, esc, 输入shift + <span class="token builtin class-name">:</span>  ，然后wq<span class="token operator">!</span>保存

// 修改authorized_keys权限
<span class="token function">chmod</span> <span class="token number">600</span> authorized_keys

// 重启ssh服务
<span class="token function">sudo</span> <span class="token function">service</span> <span class="token function">ssh</span> restart
</code></pre></div><h2 id="_4-增强服务器"><a href="#_4-增强服务器" aria-hidden="true" class="header-anchor">#</a> 4. 增强服务器</h2><h3 id="_4-1-修改服务器默认登录端口"><a href="#_4-1-修改服务器默认登录端口" aria-hidden="true" class="header-anchor">#</a> 4-1. 修改服务器默认登录端口</h3><div class="language-bash extra-class"><pre class="language-bash"><code>// 修改默认的22端口, 最好是开两个，怕修改错误后导致登录不进去了
<span class="token function">sudo</span> <span class="token function">vi</span> /etc/ssh/sshd_config

// 找到port，按下i激活修改模式，修改端口, 不要修改到0-1024端口, 然后在最下面找到UseDNS为no,在最下面新增username,esc 退出修改模式, <span class="token builtin class-name">shift</span> + :, wq<span class="token operator">!</span>保存退出
port xxxxx 
AllowUsers username

// 重启ssh服务
<span class="token function">sudo</span> <span class="token function">service</span> <span class="token function">ssh</span> restart

// 重新登录
<span class="token function">ssh</span> -p 端口号 username@ip地址
</code></pre></div><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>如果还登录不上去的话，直接去阿里云服务器的控制台添加一份安全组规则入方向，端口号为自己设定的端口号即可。</p></div><h3 id="_4-2-禁用root登录"><a href="#_4-2-禁用root登录" aria-hidden="true" class="header-anchor">#</a> 4-2. 禁用root登录</h3><div class="language-bash extra-class"><pre class="language-bash"><code>// 继续修改这个文件
<span class="token function">sudo</span> <span class="token function">vi</span> /etc/ssh/sshd_config

// 设置PermitRootLogin 和PasswordAuthentication， 保存后退出
PermitRootLogin no
和PasswordAuthentication no

// 重启ssh服务
<span class="token function">sudo</span> <span class="token function">service</span> <span class="token function">ssh</span> restart
</code></pre></div><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>记得查看有没有这个，禁止空密码登录，一定要设置为no
PermitEmptyPasswords no</p></div><h3 id="_4-3-配置-iptables-和-fail2ban-增强安全防护"><a href="#_4-3-配置-iptables-和-fail2ban-增强安全防护" aria-hidden="true" class="header-anchor">#</a> 4-3. 配置 iptables 和 Fail2Ban 增强安全防护</h3><div class="language-bash extra-class"><pre class="language-bash"><code>// 清空所有iptables规则
<span class="token function">sudo</span> iptables -F

// 添加规则, 具体配置如下
<span class="token function">sudo</span> <span class="token function">vi</span> /etc/iptables.up.rules

* filter

<span class="token comment"># allow all connections</span>
-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

<span class="token comment"># allow out traffic</span>
-A OUTPUT -j ACCEPT

<span class="token comment"># allow http https </span>
-A INPUT -p TCP --dport <span class="token number">443</span> -j ACCEPT
-A INPUT -p TCP --dport <span class="token number">80</span> -j ACCEPT
-A INPUT -p TCP --dport <span class="token number">8088</span> -j ACCEPT

<span class="token comment"># allow ssh port login</span>
-A INPUT -p tcp -m state --state NEW --dport <span class="token number">39999</span> -j ACCEPT

<span class="token comment"># ping</span>
-A INPUT -p icmp -m icmp --icmp-type <span class="token number">8</span> -j ACCEPT

<span class="token comment"># log denied calls</span>
-A INPUT -m limit --limit <span class="token number">5</span>/min -j LOG --log-prefix <span class="token string">&quot;iptables denied:&quot;</span> --log-level <span class="token number">7</span>

<span class="token comment"># drop incomming sensitive connections</span>
-A INPUT -p tcp --dport <span class="token number">80</span> -i eth0 -m state --state NEW -m recent --set
-A INPUT -p tcp --dport <span class="token number">80</span> -i eth0 -m state --state NEW -m recent --update --seconds <span class="token number">60</span> --hitcount <span class="token number">150</span> -j DROP

<span class="token comment"># reject all other inbound </span>
-A INPUT -j REJECT
-A FORWARD -j REJECT

COMMIT

// 配置路径，修改了iptables后需要执行这个命令来重启规则
<span class="token function">sudo</span> iptables-restore <span class="token operator">&lt;</span> /etc/iptables.up.rules

// 激活防火墙,查看防火墙状态
<span class="token function">sudo</span> ufw status
<span class="token function">sudo</span> ufw <span class="token builtin class-name">enable</span>

// 设置关机后自动启动的脚本，内容如下
<span class="token function">sudo</span> <span class="token function">vi</span> /etc/network/if-up.d/iptables

<span class="token comment">#!/bin/sh</span>
iptables-restore /etc/iptables.up.rules

// 给与脚本权限
<span class="token function">sudo</span> <span class="token function">chmod</span> +x /etc/network/if-up.d/iptables
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code>// 安装Fail2Ban
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> fail2ban

// 查看配置文件
<span class="token function">sudo</span> <span class="token function">vi</span> /etc/fail2ban/jail.conf

// 修改bantime,action
bantime <span class="token operator">=</span> <span class="token number">3600</span>
action <span class="token operator">=</span> %<span class="token punctuation">(</span>action_mw<span class="token punctuation">)</span>s

// 查看有没有运行
<span class="token function">sudo</span> <span class="token function">service</span> fail2ban status
</code></pre></div><h2 id="_5-搭建-nodejs-生产环境"><a href="#_5-搭建-nodejs-生产环境" aria-hidden="true" class="header-anchor">#</a> 5. 搭建 Nodejs 生产环境</h2><h3 id="_5-1-搭建服务器nodejs环境"><a href="#_5-1-搭建服务器nodejs环境" aria-hidden="true" class="header-anchor">#</a> 5-1. 搭建服务器Nodejs环境</h3><div class="language-bash extra-class"><pre class="language-bash"><code>// 更新一下系统
<span class="token function">sudo</span> <span class="token function">apt-get</span> update

// 安装需要的包
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> <span class="token function">vim</span> openssl build-essential libssl-dev <span class="token function">wget</span> <span class="token function">curl</span> <span class="token function">git</span>

// 拷贝https://github.com/creationix/nvm的脚本并且执行，安装nvm
<span class="token function">wget</span> -qO- https://raw.githubusercontent.com/creationix/nvm/v0.33.11/install.sh <span class="token operator">|</span> <span class="token function">bash</span>

// 新开一个窗口安装nodejs
nvm <span class="token function">install</span> v10.13.0

// 默认使用版本
nvm use v10.13.0
nvm <span class="token builtin class-name">alias</span> default v10.13.0

// 查看node版本，安装淘宝镜像
node -v 
<span class="token function">npm</span> <span class="token function">install</span> -g cnpm --registry<span class="token operator">=</span>https://registry.npm.taobao.org

// 增加系统文件监控数目
<span class="token builtin class-name">echo</span> fs.inotify.max_user_watches<span class="token operator">=</span><span class="token number">524288</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> -a /etc/sysctl.conf <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> sysctl -p

// 安装一些需要的模块
cnpm i pm2 webpack gulp grunt-cli -g

// 在根目录写一个app.js启动服务
<span class="token function">vi</span> app.js
const http <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
http.createServer<span class="token punctuation">((</span>req,res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    res.writeHead<span class="token punctuation">(</span><span class="token number">200</span>, <span class="token punctuation">{</span><span class="token string">'Content-type'</span><span class="token builtin class-name">:</span> <span class="token string">'text/plain'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    res.end<span class="token punctuation">(</span><span class="token string">'hello world'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>.listen<span class="token punctuation">(</span><span class="token number">8081</span>, <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    console.log<span class="token punctuation">(</span><span class="token string">'Server running!'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
node app.js

// 访问ip地址加端口号即可,如果没有反应需要在服务器配置安全组8081的端口号进出口规则
</code></pre></div><h3 id="_5-2-部署pm2"><a href="#_5-2-部署pm2" aria-hidden="true" class="header-anchor">#</a> 5-2. 部署pm2</h3><div class="language-bash extra-class"><pre class="language-bash"><code>// 可以直接通过pm2开启服务
pm2 start app.js

// 查看列表
pm2 list

// 查看详情
pm2 show app

// 查看日志
pm2 logs
</code></pre></div><h2 id="_6-配置-nginx-反向代理-nodejs-端口"><a href="#_6-配置-nginx-反向代理-nodejs-端口" aria-hidden="true" class="header-anchor">#</a> 6. 配置 Nginx 反向代理 Nodejs 端口</h2><div class="language-bash extra-class"><pre class="language-bash"><code>// 安装nginx，版本
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> nginx
nginx -v

// 查看文件
<span class="token builtin class-name">cd</span> /etc/nginx/
<span class="token function">ls</span>
<span class="token builtin class-name">cd</span> conf.d

// 新建配置文件
<span class="token function">sudo</span> <span class="token function">vi</span> xxx-com-8080.conf<span class="token punctuation">(</span>文件名<span class="token punctuation">)</span>

upstream xxx <span class="token punctuation">{</span>
    server <span class="token number">127.0</span>.0.1:8081<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

server <span class="token punctuation">{</span>
  listen: <span class="token number">80</span><span class="token punctuation">;</span>
  server_name: ip地址或者域名地址<span class="token punctuation">;</span>

  location / <span class="token punctuation">{</span>
    proxy_set_header X-Real-IP <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
    proxy_set_header X-Forward-For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>
    proxy_set_header Host <span class="token variable">$http_host</span><span class="token punctuation">;</span>
    proxy_set_header X-Nginx-Proxy <span class="token boolean">true</span><span class="token punctuation">;</span>
    proxy_pass http://xxx<span class="token punctuation">;</span>
    proxy_redirect off<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  location ~* ^.+<span class="token punctuation">\</span>.<span class="token punctuation">(</span>jpg<span class="token operator">|</span>jgeg<span class="token operator">|</span>gif<span class="token operator">|</span>png<span class="token operator">|</span>ico<span class="token operator">|</span>css<span class="token operator">|</span>js<span class="token operator">|</span>pdf<span class="token operator">|</span>txt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    root /www/wx-jssdk/production/current/public<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

// 查看nginx.conf文件
<span class="token function">sudo</span> <span class="token function">vi</span> nginx.conf
查看这句是否正确include /etc/nginx/conf.d/*.conf<span class="token punctuation">;</span>
取消注释 server_tokens off,这句是后台返回的server里面不显示版本信息，只显示一个nginx


// 测试配置文件是否正确
<span class="token function">sudo</span> nginx -t

// 重启nginx
<span class="token function">sudo</span> nginx -s reload

// 访问ip地址即可,如果没有反应需要在服务器配置安全组80的端口号进出口规则
// 解析域名，填入自己的ip地址即可，可以访问域名+端口号
</code></pre></div><h2 id="_7-服务器配置安装-mongodb"><a href="#_7-服务器配置安装-mongodb" aria-hidden="true" class="header-anchor">#</a> 7. 服务器配置安装 MongoDB</h2><h3 id="_7-1-安装-mongodb"><a href="#_7-1-安装-mongodb" aria-hidden="true" class="header-anchor">#</a> 7-1. 安装 MongoDB</h3><div class="language-bash extra-class"><pre class="language-bash"><code>// 根据步骤安装 
https://docs.mongodb.com/manual/tutorial/install-mongodb-on-ubuntu/

// 开启mongodb
<span class="token function">sudo</span> <span class="token function">service</span> mongod start

// 查看日志有没有开启,或者直接mongo
<span class="token function">cat</span> /var/log/mongodb/mongod.log
mongo

// 在iptables中开启27017这个端口，不然mongo链接失败
<span class="token comment"># mongodb connection</span>
-A INPUT -s <span class="token number">127.0</span>.0.1 -p tcp --destination-port <span class="token number">27017</span> -m state --state NEW,ESTABLISHED -j ACCEPT
-A OUTPUT -d <span class="token number">127.0</span>.0.1 -p tcp --source-port <span class="token number">27017</span> -m state --state ESTABLISHED -j ACCEPT

// 重启规则
<span class="token function">sudo</span> iptables-restore <span class="token operator">&lt;</span> /etc/iptables.up.rules

// 停止和重启mongodb
<span class="token function">sudo</span> <span class="token function">service</span> mongod stop <span class="token operator">||</span> restart

// 修改默认27017端口，找到net下面port修改，然后记得更新iptables，重载iptabales
<span class="token function">sudo</span> <span class="token function">vi</span> /etc/mongod.conf

// 登录mongo
mongo --port xxxxx
</code></pre></div><h2 id="_8-服务器正式部署和发布上线项目"><a href="#_8-服务器正式部署和发布上线项目" aria-hidden="true" class="header-anchor">#</a> 8. 服务器正式部署和发布上线项目</h2><h3 id="_8-1-上传项目代码到线上私有-git-仓库"><a href="#_8-1-上传项目代码到线上私有-git-仓库" aria-hidden="true" class="header-anchor">#</a> 8-1. 上传项目代码到线上私有 Git 仓库</h3><ul><li>把本地和服务器的公钥都放在码云上面，然后在码云生成一个私有项目，并且在服务器git clone下来</li></ul><h3 id="_8-2-配置-pm2-一键部署线上项目结构"><a href="#_8-2-配置-pm2-一键部署线上项目结构" aria-hidden="true" class="header-anchor">#</a> 8-2. 配置 PM2 一键部署线上项目结构</h3><p>通过pm2这个工具，在我们本地的命令行上登录服务器，通知服务器从git仓库把代码clone到服务器里面，然后部署到相应的文件夹中</p><ul><li>配置PM2 ecosystem.json</li></ul><div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;apps&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;xxx&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;script&quot;</span><span class="token operator">:</span> <span class="token string">&quot;app.js&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 启动js</span>
      <span class="token property">&quot;env&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;COMON_VARIABLE&quot;</span><span class="token operator">:</span> <span class="token string">&quot;true&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;env_production&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;NODE_ENV&quot;</span><span class="token operator">:</span> <span class="token string">&quot;production&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;deploy&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;production&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;user&quot;</span><span class="token operator">:</span> <span class="token string">&quot;配置好权限了的的用户帐号&quot;</span><span class="token punctuation">,</span> 
      <span class="token property">&quot;host&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;服务器ip地址&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">&quot;ref&quot;</span><span class="token operator">:</span> <span class="token string">&quot;origin/master&quot;</span><span class="token punctuation">,</span> 
      <span class="token property">&quot;repo&quot;</span><span class="token operator">:</span> <span class="token string">&quot;git仓库地址&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;port&quot;</span><span class="token operator">:</span> <span class="token string">&quot;端口号&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;~/www/wx-jssdk/production&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 服务器路径</span>
      <span class="token property">&quot;post-deploy&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;cnpm i &amp;&amp; pm2 startOrRestart ecosystem.json --env production&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 部署的时候执行npm install</span>
      <span class="token property">&quot;ssh_options&quot;</span><span class="token operator">:</span> <span class="token string">&quot;StrictHostKeyChecking=no&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;env&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;NODE_ENV&quot;</span><span class="token operator">:</span> <span class="token string">&quot;production&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code>// 初始化服务器应用
pm2 deploy ecosystem.json production setup

// 如果遇到mkdir: cannot create directory ‘/project’: Permission denied错误,就是权限问题
// 在服务器根目录创建www和wx-jssdk，在www文件夹下面 <span class="token function">sudo</span> <span class="token function">chmod</span> <span class="token number">777</span> wx-jssdk，修改文件夹权限， 如果成功ls会显示绿色

// 开始部署， 如果出现bash: pm2: <span class="token builtin class-name">command</span> not found报错的话,执行下面的操作
pm2 deploy ecosystem.json production

// 修改pm2
<span class="token function">vi</span> .bashrc

// 注释这几行,: + wq<span class="token operator">!</span>保存， 执行source .bashrc重载， 重新执行命令， 如果出现File ecosystem.json not found报错的话, 把代码git push更新到服务器即可
<span class="token comment">#case $- in</span>
<span class="token comment">#    *i*) ;;</span>
<span class="token comment">#      *) return;;</span>
<span class="token comment">#esac</span>

</code></pre></div><h2 id="_9-配置https证书"><a href="#_9-配置https证书" aria-hidden="true" class="header-anchor">#</a> 9. 配置https证书</h2><div class="language-bash extra-class"><pre class="language-bash"><code>// 把解压后的证书上传服务器,:/home/xxx代表复制到服务器的那个路径中
<span class="token function">scp</span> -P <span class="token number">19999</span><span class="token punctuation">(</span>服务器端口号<span class="token punctuation">)</span> ./xxx.crt root@服务器ip地址:/home/xxx
<span class="token function">scp</span> -P <span class="token number">19999</span><span class="token punctuation">(</span>服务器端口号<span class="token punctuation">)</span> ./xxx.key root@服务器ip地址:/home/xxx

// 修改nginx配置
upstream tag <span class="token punctuation">{</span>
  server <span class="token number">127.0</span>.0.1:8081<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

server <span class="token punctuation">{</span>
  listen <span class="token number">80</span><span class="token punctuation">;</span>
  server_name www.xxx.com<span class="token punctuation">;</span>
  <span class="token comment">#rewrite ^(.*) https://$host$1 permanent;</span>
  <span class="token builtin class-name">return</span> <span class="token number">301</span> https://www.xxx.com<span class="token variable">$request_uri</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

server <span class="token punctuation">{</span>
  listen <span class="token number">443</span><span class="token punctuation">;</span>
  server_name www.xxx.com<span class="token punctuation">;</span>
  ssl on<span class="token punctuation">;</span>
  ssl_certificate /etc/nginx/conf.d/ssl/cert-1541496084645_www.khweb.top.crt<span class="token punctuation">;</span>
  ssl_certificate_key /etc/nginx/conf.d/ssl/cert-1541496084645_www.khweb.top.key<span class="token punctuation">;</span>
  ssl_session_timeout 5m<span class="token punctuation">;</span>
  ssl_protocols SSLv2 SSLv3 TLSv1<span class="token punctuation">;</span>
  ssl_ciphers ALL:<span class="token operator">!</span>ADH:<span class="token operator">!</span>EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP<span class="token punctuation">;</span>
  ssl_prefer_server_ciphers on<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$ssl_protocol</span> <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    rewrite ^<span class="token punctuation">(</span>.*<span class="token punctuation">)</span> https://<span class="token variable">$host</span><span class="token variable">$1</span> permanent<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  location / <span class="token punctuation">{</span>
    proxy_set_header X-Real-IP <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
    proxy_set_header X-Forward-For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>
    proxy_set_header Host <span class="token variable">$http_host</span><span class="token punctuation">;</span>
    proxy_set_header X-Nginx-Proxy <span class="token boolean">true</span><span class="token punctuation">;</span>
    proxy_pass http://tag<span class="token punctuation">;</span>
    proxy_redirect off<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


// 重启nginx
<span class="token function">sudo</span> nginx -s reload

// 服务器安全组配置443端口即可
</code></pre></div><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>存放证书的路径不要放在根目录,不然sudo nginx -t会报错</p></div></div><div class="page-edit"><!----><!----></div><!----></div></div></div>
    <script src="/assets/js/app.8f0dc81e.js" defer></script><script src="/assets/js/13.bb8216ef.js" defer></script>
  </body>
</html>
